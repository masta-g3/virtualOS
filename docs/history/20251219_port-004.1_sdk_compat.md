# port-004.1: Fix Gemini/Anthropic SDK Version Incompatibility

**Status:** Complete
**Priority:** 2
**Dependencies:** None
**Discovered from:** port-005

## Problem Statement

The AI SDK port has a version mismatch between the core `ai` package and provider SDKs:

```
Current versions:
├── ai@4.3.19           → expects LanguageModelV1
├── @ai-sdk/openai@1.3.24    → returns LanguageModelV1 ✓
├── @ai-sdk/google@2.0.49    → returns LanguageModelV2 ✗
├── @ai-sdk/anthropic@2.0.56 → returns LanguageModelV2 ✗
```

**Root cause:** Provider SDKs were updated to v2 model specification while core `ai` package is still at v4.x which only accepts v1 models.

**Verification:**
```typescript
// Returns "v1" - compatible
openai('gpt-4o-mini').specificationVersion

// Returns "v2" - INCOMPATIBLE with ai@4.x
google('gemini-2.0-flash').specificationVersion
anthropic('claude-sonnet-4-5').specificationVersion
```

## Solution Analysis

### Option A: Upgrade to AI SDK 5 (Recommended)

**Pros:**
- Provider SDKs already compatible
- Access to latest features (tool streaming, improved types)
- Future-proof

**Cons:**
- Breaking changes in tool definitions (`parameters` → `inputSchema`)
- Breaking changes in tool call results (`args` → `input`)
- Requires updating all tool definitions

### Option B: Downgrade Provider Packages

**Pros:**
- Minimal code changes
- Keeps current API stable

**Cons:**
- Older model IDs (may not support latest models)
- Fighting against ecosystem direction
- Version pinning maintenance burden

**Decision:** Option A - Upgrade to AI SDK 5

The migration is straightforward for server-side code. The breaking changes are:
1. `parameters` → `inputSchema` in tool definitions
2. `args` → `input` in tool call results (we access via `tc.args`)

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                       Before (Broken)                                │
│  ai@4.3.19 ──expects──> LanguageModelV1                             │
│       ↑                      ↑ (OK)      ↑ (FAIL)     ↑ (FAIL)      │
│  openai@1.3    google@2.0     anthropic@2.0                         │
│  (V1 models)   (V2 models)    (V2 models)                           │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ upgrade
┌─────────────────────────────────────────────────────────────────────┐
│                        After (Fixed)                                 │
│  ai@5.0.x ──accepts──> LanguageModelV1 OR LanguageModelV2           │
│       ↑                      ↑             ↑             ↑          │
│  openai@1.3    google@2.0     anthropic@2.0                         │
│     ✓              ✓               ✓                                │
└─────────────────────────────────────────────────────────────────────┘
```

## Migration Reference

### Tool Definition Changes

```typescript
// AI SDK 4.x
const myTool = tool({
  description: "...",
  parameters: z.object({           // ← "parameters"
    name: z.string(),
  }),
  execute: async ({ name }) => {},
});

// AI SDK 5.x
const myTool = tool({
  description: "...",
  inputSchema: z.object({          // ← "inputSchema"
    name: z.string(),
  }),
  execute: async ({ name }) => {},
});
```

### Tool Result Access Changes

```typescript
// AI SDK 4.x
for (const tc of step.toolCalls) {
  console.log(tc.args);            // ← "args"
}

// AI SDK 5.x
for (const tc of step.toolCalls) {
  console.log(tc.input);           // ← "input"
}
```

## Implementation Plan

### Phase 1: Upgrade Dependencies

- [x] Update `ai` package from `^4.3.0` to `^5.0.0`
- [x] Verify provider packages remain compatible (they already use v2)
- [x] Run `npm install` to update lock file
- [x] Verify TypeScript compiles (expect errors from breaking changes)

```bash
npm install ai@^5.0.0
```

### Phase 2: Update Tool Definitions

**Files to modify:**
- `src/tools/file-tools.ts`
- `src/tools/research-tools.ts`

Changes per file:

**file-tools.ts** (3 tools):
- [x] `writeFile`: `parameters` → `inputSchema`
- [x] `readFile`: `parameters` → `inputSchema`
- [x] `runShell`: `parameters` → `inputSchema`

**research-tools.ts** (3 tools):
- [x] `searchArxiv`: `parameters` → `inputSchema`
- [x] `getPaperSummaries`: `parameters` → `inputSchema`
- [x] `fetchPaper`: `parameters` → `inputSchema`

### Phase 3: Update Tool Result Access

**Files to modify:**
- `src/agent.ts`

- [x] Change `tc.args` to `tc.input` in tool call extraction
- [x] Change `maxSteps: 50` to `stopWhen: stepCountIs(50)`
- [x] Change `toolResult.result` to `toolResult.output`

```typescript
// Before
toolCalls.push({
  name: tc.toolName,
  args: tc.args as Record<string, unknown>,  // ← args
  result: String(toolResult?.result ?? ""),
});

// After
toolCalls.push({
  name: tc.toolName,
  args: tc.input as Record<string, unknown>,  // ← input (keep field name for API compat)
  result: String(toolResult?.result ?? ""),
});
```

### Phase 4: Verification

- [x] `npm run test` - All unit tests pass (34/34)
- [x] TypeScript compilation clean: `npx tsc --noEmit`
- [x] CLI help works: `npm run cli`
- [ ] `npm run cli -- "hello"` - OpenAI works (requires OPENAI_API_KEY)
- [ ] `npm run cli -- --model gemini "hello"` - Gemini works (requires GOOGLE_GENERATIVE_AI_API_KEY)
- [ ] `npm run cli -- --model anthropic "hello"` - Anthropic works (requires ANTHROPIC_API_KEY)

### Phase 5: Update Models (Optional Enhancement)

While we're fixing compatibility, update to better model defaults:

- [x] OpenAI: `gpt-4o-mini` → `gpt-4o` (better tool use)
- [x] Gemini: `gemini-1.5-flash` → `gemini-2.0-flash` (latest)
- [x] Anthropic: `claude-3-5-sonnet-20241022` → `claude-sonnet-4-5` (latest)

```typescript
// src/models.ts - updated model IDs
case "openai":
  return { model: openai("gpt-4o") };
case "gemini":
  return { model: google("gemini-2.0-flash") };
case "anthropic":
  return { model: anthropic("claude-sonnet-4-5") };
```

## Files Changed Summary

| File | Action | Changes |
|------|--------|---------|
| `package.json` | Modify | `ai` version ^4.3.0 → ^5.0.0 |
| `src/tools/file-tools.ts` | Modify | `parameters` → `inputSchema` (3 tools) |
| `src/tools/research-tools.ts` | Modify | `parameters` → `inputSchema` (3 tools) |
| `src/agent.ts` | Modify | `tc.args` → `tc.input` |
| `src/models.ts` | Modify | Update model IDs to latest |

## Testing Checklist

```bash
# Unit tests
npm run test

# Manual verification (with API keys)
npm run cli -- "What is 2+2?"
npm run cli -- --model gemini "What is 2+2?"
npm run cli -- --model anthropic "What is 2+2?"

# Tool use verification
npm run cli -- "List files in current directory"
npm run cli -- --model gemini "Write hello.txt with 'Hello World'"

# TypeScript verification
npx tsc --noEmit
```

## Rollback Plan

If issues arise:
```bash
npm install ai@^4.3.0
git checkout src/tools/file-tools.ts src/tools/research-tools.ts src/agent.ts
```

## Notes

- The `tool()` function signature change is the main breaking change
- `execute` function signature remains the same (destructured input object)
- No changes needed to Zod schemas themselves
- Provider-specific options (thinking, reasoning) are a separate feature (port-004)
